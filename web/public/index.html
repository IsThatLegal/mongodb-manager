<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Cluster Manager - Cloud Dashboard</title>
    <style>
        :root {
            /* Light theme variables */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-tertiary: rgba(255, 255, 255, 0.9);
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-card-hover: rgba(255, 255, 255, 0.8);
            --bg-input: rgba(255, 255, 255, 0.9);
            --bg-code: #2c3e50;
            --text-primary: #333;
            --text-secondary: #2c3e50;
            --text-muted: #7f8c8d;
            --text-code: #ecf0f1;
            --text-inverse: rgba(255,255,255,0.8);
            --border-primary: rgba(255,255,255,0.2);
            --border-input: rgba(255,255,255,0.3);
            --border-focus: #667eea;
            --shadow-primary: 0 8px 32px rgba(0,0,0,0.1);
            --shadow-card: 0 20px 40px rgba(0,0,0,0.15);
            --accent-primary: #667eea;
            --accent-secondary: #f093fb;
            --accent-success: #4facfe;
            --status-success: #27ae60;
            --status-error: #e74c3c;
            --status-warning: #f39c12;
        }

        [data-theme="dark"] {
            /* Dark theme variables */
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(44, 62, 80, 0.95);
            --bg-tertiary: rgba(52, 73, 94, 0.9);
            --bg-card: rgba(52, 73, 94, 0.9);
            --bg-card-hover: rgba(44, 62, 80, 0.8);
            --bg-input: rgba(44, 62, 80, 0.9);
            --bg-code: #1e2834;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-muted: #95a5a6;
            --text-code: #ecf0f1;
            --text-inverse: rgba(236,240,241,0.8);
            --border-primary: rgba(236,240,241,0.2);
            --border-input: rgba(236,240,241,0.3);
            --border-focus: #3498db;
            --shadow-primary: 0 8px 32px rgba(0,0,0,0.3);
            --shadow-card: 0 20px 40px rgba(0,0,0,0.4);
            --accent-primary: #3498db;
            --accent-secondary: #e74c3c;
            --accent-success: #2ecc71;
            --status-success: #2ecc71;
            --status-error: #e74c3c;
            --status-warning: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-primary);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .header-content h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .header-content .subtitle {
            opacity: 0.7;
            font-size: 0.9rem;
            margin-top: 0.25rem;
            color: var(--text-muted);
        }

        .theme-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }

        .theme-selector label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .theme-selector select {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-input);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-selector select:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .status-bar {
            background: var(--bg-tertiary);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-primary);
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-error);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--status-success);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-primary);
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-card);
            background: var(--bg-card-hover);
        }

        .card h3 {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-primary) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            filter: brightness(1.1);
        }

        .btn.secondary {
            background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-secondary) 100%);
        }

        .btn.success {
            background: linear-gradient(135deg, var(--accent-success) 0%, var(--accent-success) 100%);
        }

        .cluster-list {
            list-style: none;
        }

        .cluster-item {
            background: var(--bg-input);
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-primary);
            transition: all 0.3s ease;
        }

        .cluster-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
        }

        .cluster-item[onclick] {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cluster-item[onclick]:hover {
            background: var(--bg-card-hover);
            transform: translateX(8px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .database-browser {
            grid-column: 1 / -1; /* Full width */
        }

        .database-item {
            background: var(--bg-input);
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-success);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .database-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
        }

        .database-item.expanded {
            border-left-color: var(--accent-primary);
            background: var(--bg-card);
        }

        .database-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .database-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .database-info {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .collections-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-primary);
            display: none;
        }

        .collections-container.expanded {
            display: block;
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .collection-item {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid var(--accent-secondary);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .collection-item:hover {
            background: var(--bg-card-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .collection-name {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .collection-stats {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .cluster-name {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .cluster-env {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .data-display {
            background: var(--bg-code);
            color: var(--text-code);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
            border: 1px solid var(--border-primary);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .error {
            background: var(--status-error);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: var(--status-success);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .input-group {
            margin: 1rem 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-input);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-inverse);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üçÉ MongoDB Cluster Manager</h1>
            <div class="subtitle">Cloud Dashboard - Serverless Edition</div>
        </div>
        <div class="theme-selector">
            <label for="themeSelect">Theme:</label>
            <select id="themeSelect" onchange="switchTheme()">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </div>
    </div>

    <div class="container">
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="statusText">Connecting to API...</span>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Clusters Card -->
            <div class="card">
                <h3>üåê Clusters</h3>
                <button class="btn" onclick="loadClusters()">Refresh Clusters</button>
                <div id="clustersList">
                    <div class="loading">Loading clusters...</div>
                </div>
            </div>

            <!-- Database Browser Card -->
            <div class="card database-browser">
                <h3>üóÑÔ∏è Database Browser</h3>
                <div id="databaseBrowser">
                    <div class="loading">Loading your databases...</div>
                </div>
            </div>

            <!-- Query Tool Card -->
            <div class="card">
                <h3>üîç Query Tool</h3>
                <div class="input-group">
                    <label for="queryCluster">Cluster:</label>
                    <select id="queryCluster">
                        <option value="">Select cluster...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="queryDatabase">Database:</label>
                    <input type="text" id="queryDatabase" placeholder="database name">
                </div>
                <div class="input-group">
                    <label for="queryCollection">Collection:</label>
                    <input type="text" id="queryCollection" placeholder="collection name">
                </div>
                <div class="input-group">
                    <label for="queryFilter">Filter (JSON):</label>
                    <textarea id="queryFilter" rows="3" placeholder='{"status": "active"}'></textarea>
                </div>
                <button class="btn success" onclick="executeQuery()">Execute Query</button>
                <div id="queryResults"></div>
            </div>

            <!-- Health Check Card -->
            <div class="card">
                <h3>‚ù§Ô∏è Health Status</h3>
                <button class="btn secondary" onclick="checkHealth()">Check API Health</button>
                <div id="healthStatus">
                    <div class="loading">Click to check health status</div>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div class="card">
            <h3>üìä Results</h3>
            <div id="resultsDisplay">
                <div class="loading">Results will appear here...</div>
            </div>
        </div>
    </div>

    <div class="footer">
        MongoDB Cluster Manager - Cloud Edition | Powered by Vercel Serverless
    </div>

    <script>
        class MongoDBDashboard {
            constructor() {
                this.baseURL = window.location.origin;
                this.clusters = [];
                this.init();
            }

            async init() {
                await this.checkAPIHealth();
                await this.loadClusters();
                await this.autoLoadDatabaseBrowser(); // Automatically load the integrated browser
                this.updateConnectionStatus(true);
            }

            async checkAPIHealth() {
                try {
                    const response = await fetch(`${this.baseURL}/health`);
                    const health = await response.json();
                    this.displayResults('Health Check', health);
                    this.updateConnectionStatus(true);
                    return health;
                } catch (error) {
                    console.error('Health check failed:', error);
                    this.displayError('Health check failed: ' + error.message);
                    this.updateConnectionStatus(false);
                    return null;
                }
            }

            async loadClusters() {
                try {
                    this.updateStatus('Loading clusters...');
                    const response = await fetch(`${this.baseURL}/api/clusters`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.clusters = await response.json();
                    this.displayClusters();
                    this.populateClusterSelects();
                    this.updateConnectionStatus(true);
                } catch (error) {
                    console.error('Failed to load clusters:', error);
                    this.displayError('Failed to load clusters: ' + error.message);
                    this.updateConnectionStatus(false);
                }
            }

            async autoLoadDatabaseBrowser() {
                // Automatically load the integrated database browser
                if (this.clusters.length === 0) {
                    document.getElementById('databaseBrowser').innerHTML = '<div class="loading">No clusters available</div>';
                    return;
                }

                // Use the first available cluster (usually Cluster0)
                const primaryCluster = this.clusters[0];
                await this.loadDatabaseBrowser(primaryCluster.name);
            }

            async loadDatabaseBrowser(clusterName) {
                try {
                    this.updateStatus('Loading database browser...');
                    const response = await fetch(`${this.baseURL}/api/databases/${clusterName}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const databases = await response.json();
                    this.displayDatabaseBrowser(databases, clusterName);
                } catch (error) {
                    console.error('Failed to load database browser:', error);
                    document.getElementById('databaseBrowser').innerHTML = `<div class="error">Failed to load databases: ${error.message}</div>`;
                }
            }

            displayDatabaseBrowser(databases, clusterName) {
                const container = document.getElementById('databaseBrowser');
                
                if (databases.length === 0) {
                    container.innerHTML = '<div class="loading">No databases found</div>';
                    return;
                }

                // Filter out system databases by default, but show them as expandable
                const userDatabases = databases.filter(db => !['admin', 'local', 'config'].includes(db.name));
                const systemDatabases = databases.filter(db => ['admin', 'local', 'config'].includes(db.name));

                const databasesHTML = [
                    ...userDatabases.map(db => this.createDatabaseHTML(db, clusterName)),
                    systemDatabases.length > 0 ? `
                        <div class="database-item" onclick="toggleSystemDatabases()">
                            <div class="database-header">
                                <div>
                                    <div class="database-name">üìÅ System Databases</div>
                                    <div class="database-info">${systemDatabases.length} system databases (admin, local, config)</div>
                                </div>
                                <div style="color: var(--text-muted);">‚ñº</div>
                            </div>
                            <div class="collections-container" id="systemDatabases">
                                ${systemDatabases.map(db => this.createDatabaseHTML(db, clusterName)).join('')}
                            </div>
                        </div>
                    ` : ''
                ].join('');

                container.innerHTML = databasesHTML;
            }

            createDatabaseHTML(database, clusterName) {
                const sizeInfo = database.sizeOnDisk ? `${(database.sizeOnDisk / 1024 / 1024).toFixed(2)} MB` : 'Unknown size';
                
                return `
                    <div class="database-item" onclick="toggleDatabase('${database.name}', '${clusterName}')" id="db-${database.name}">
                        <div class="database-header">
                            <div>
                                <div class="database-name">${database.name}</div>
                                <div class="database-info">${sizeInfo} ‚Ä¢ Click to explore collections</div>
                            </div>
                            <div style="color: var(--text-muted); transition: transform 0.3s ease;" class="expand-arrow">‚ñº</div>
                        </div>
                        <div class="collections-container" id="collections-${database.name}">
                            <div class="loading" style="text-align: center; padding: 1rem; color: var(--text-muted);">Loading collections...</div>
                        </div>
                    </div>
                `;
            }

            async loadDatabases() {
                const clusterName = document.getElementById('clusterSelect').value;
                if (!clusterName) return;

                try {
                    this.updateStatus('Loading databases...');
                    const response = await fetch(`${this.baseURL}/api/databases/${clusterName}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const databases = await response.json();
                    this.displayDatabases(databases);
                } catch (error) {
                    console.error('Failed to load databases:', error);
                    this.displayError('Failed to load databases: ' + error.message);
                }
            }

            async loadCollections() {
                const clusterName = document.getElementById('clusterSelect').value;
                const databaseName = document.getElementById('databaseSelect').value;
                
                if (!clusterName || !databaseName) {
                    document.getElementById('collectionsList').innerHTML = '<div class="loading">Select a cluster and database to view collections</div>';
                    return;
                }

                try {
                    this.updateStatus('Loading collections...');
                    const response = await fetch(`${this.baseURL}/api/collections/${clusterName}/${databaseName}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const collections = await response.json();
                    this.displayCollections(collections);
                } catch (error) {
                    console.error('Failed to load collections:', error);
                    this.displayError('Failed to load collections: ' + error.message);
                }
            }

            displayCollections(collections) {
                const container = document.getElementById('collectionsList');
                
                if (collections.length === 0) {
                    container.innerHTML = '<div class="loading">No collections found</div>';
                    return;
                }

                const collectionsHTML = collections.map(collection => `
                    <div class="cluster-item" onclick="selectCollection('${collection.name}')">
                        <div class="cluster-name">${collection.name}</div>
                        <div class="cluster-env">
                            ${collection.count !== undefined && collection.count !== 'Unknown' ? 
                                (typeof collection.count === 'number' ? collection.count.toLocaleString() : collection.count) + ' documents' : 
                                'Unknown count'} ‚Ä¢ 
                            ${collection.size && collection.size > 0 ? `${(collection.size / 1024).toFixed(1)} KB` : 'Unknown size'}
                            ${collection.indexes && collection.indexes > 0 ? ` ‚Ä¢ ${collection.indexes} indexes` : ''}
                        </div>
                        ${collection.error ? `<div style="color: var(--status-warning); font-size: 0.8rem; margin-top: 0.5rem;">‚ö†Ô∏è ${collection.error}</div>` : ''}
                    </div>
                `).join('');

                container.innerHTML = collectionsHTML;
            }

            async executeQuery() {
                const cluster = document.getElementById('queryCluster').value;
                const database = document.getElementById('queryDatabase').value;
                const collection = document.getElementById('queryCollection').value;
                const filterText = document.getElementById('queryFilter').value;

                if (!cluster || !database || !collection) {
                    this.displayError('Please fill in cluster, database, and collection fields');
                    return;
                }

                let filter = {};
                try {
                    if (filterText.trim()) {
                        filter = JSON.parse(filterText);
                    }
                } catch (error) {
                    this.displayError('Invalid JSON in filter field');
                    return;
                }

                try {
                    this.updateStatus('Executing query...');
                    const response = await fetch(`${this.baseURL}/api/query/${cluster}/${database}/${collection}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filter: filter,
                            limit: 10
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const results = await response.json();
                    this.displayResults('Query Results', results);
                } catch (error) {
                    console.error('Query failed:', error);
                    this.displayError('Query failed: ' + error.message);
                }
            }

            displayClusters() {
                const container = document.getElementById('clustersList');
                
                if (this.clusters.length === 0) {
                    container.innerHTML = '<div class="loading">No clusters configured</div>';
                    return;
                }

                const clustersHTML = this.clusters.map(cluster => `
                    <div class="cluster-item">
                        <div class="cluster-name">${cluster.name || 'Unnamed Cluster'}</div>
                        <div class="cluster-env">
                            ${cluster.description || 'MongoDB Cluster'} ‚Ä¢ 
                            ${cluster.environment || 'Unknown'} ‚Ä¢ 
                            Status: ${cluster.status || 'Unknown'}
                            ${cluster.totalDatabases ? ` ‚Ä¢ ${cluster.totalDatabases} databases` : ''}
                            ${cluster.version ? ` ‚Ä¢ v${cluster.version}` : ''}
                        </div>
                        ${cluster.error ? `<div style="color: var(--status-error); font-size: 0.8rem; margin-top: 0.5rem;">Error: ${cluster.error}</div>` : ''}
                    </div>
                `).join('');

                container.innerHTML = clustersHTML;
            }

            displayDatabases(databases) {
                const container = document.getElementById('databasesList');
                const databaseSelect = document.getElementById('databaseSelect');
                
                if (databases.length === 0) {
                    container.innerHTML = '<div class="loading">No databases found</div>';
                    databaseSelect.innerHTML = '<option value="">No databases available</option>';
                    return;
                }

                // Populate the databases list display
                const databasesHTML = databases.map(db => `
                    <div class="cluster-item" onclick="selectDatabase('${db.name}')">
                        <div class="cluster-name">${db.name}</div>
                        <div class="cluster-env">Size: ${db.sizeOnDisk ? (db.sizeOnDisk / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown'}</div>
                    </div>
                `).join('');

                container.innerHTML = databasesHTML;

                // Populate the database dropdown for collections
                databaseSelect.innerHTML = '<option value="">Choose a database...</option>';
                databases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db.name;
                    option.textContent = db.name;
                    databaseSelect.appendChild(option);
                });
            }

            populateClusterSelects() {
                const selects = ['clusterSelect', 'queryCluster'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    // Clear existing options except the first
                    select.innerHTML = select.children[0].outerHTML;
                    
                    this.clusters.forEach(cluster => {
                        const option = document.createElement('option');
                        option.value = cluster.name || cluster.id || 'unknown';
                        option.textContent = cluster.name || cluster.id || 'Unknown Cluster';
                        select.appendChild(option);
                    });
                });
            }

            displayResults(title, data) {
                const container = document.getElementById('resultsDisplay');
                container.innerHTML = `
                    <h4>${title}</h4>
                    <div class="data-display">${JSON.stringify(data, null, 2)}</div>
                `;
            }

            displayError(message) {
                const container = document.getElementById('resultsDisplay');
                container.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            }

            displaySuccess(message) {
                const container = document.getElementById('resultsDisplay');
                container.innerHTML = `<div class="success">‚úÖ ${message}</div>`;
            }

            updateStatus(message) {
                document.getElementById('statusText').textContent = message;
            }

            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected to MongoDB Manager API';
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Disconnected from API';
                }
            }
        }

        // Theme Management
        class ThemeManager {
            constructor() {
                this.currentTheme = 'system';
                this.init();
            }

            init() {
                // Load saved theme preference
                const savedTheme = localStorage.getItem('mongodb-manager-theme') || 'system';
                this.setTheme(savedTheme);
                
                // Update select value
                document.getElementById('themeSelect').value = savedTheme;

                // Listen for system theme changes
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                        if (this.currentTheme === 'system') {
                            this.applySystemTheme();
                        }
                    });
                }
            }

            setTheme(theme) {
                this.currentTheme = theme;
                localStorage.setItem('mongodb-manager-theme', theme);

                if (theme === 'system') {
                    this.applySystemTheme();
                } else {
                    this.applyTheme(theme);
                }
            }

            applySystemTheme() {
                const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                this.applyTheme(isDark ? 'dark' : 'light');
            }

            applyTheme(theme) {
                const html = document.documentElement;
                
                if (theme === 'dark') {
                    html.setAttribute('data-theme', 'dark');
                } else {
                    html.removeAttribute('data-theme');
                }
            }

            toggleTheme() {
                const themes = ['system', 'light', 'dark'];
                const currentIndex = themes.indexOf(this.currentTheme);
                const nextTheme = themes[(currentIndex + 1) % themes.length];
                this.setTheme(nextTheme);
                document.getElementById('themeSelect').value = nextTheme;
            }
        }

        // Initialize theme manager
        const themeManager = new ThemeManager();

        // Global theme switch function
        function switchTheme() {
            const select = document.getElementById('themeSelect');
            themeManager.setTheme(select.value);
        }

        // Global functions for button clicks
        async function loadClusters() {
            await dashboard.loadClusters();
        }

        async function loadDatabases() {
            await dashboard.loadDatabases();
        }

        async function loadCollections() {
            await dashboard.loadCollections();
        }

        function selectDatabase(databaseName) {
            const databaseSelect = document.getElementById('databaseSelect');
            databaseSelect.value = databaseName;
            loadCollections();
        }

        function selectCollection(collectionName) {
            // Auto-fill the query tool with selected collection
            const clusterSelect = document.getElementById('clusterSelect');
            const databaseSelect = document.getElementById('databaseSelect');
            
            document.getElementById('queryCluster').value = clusterSelect.value;
            document.getElementById('queryDatabase').value = databaseSelect.value;
            document.getElementById('queryCollection').value = collectionName;
            
            // Scroll to query tool
            document.getElementById('queryCollection').closest('.card').scrollIntoView({ behavior: 'smooth' });
        }

        async function toggleDatabase(databaseName, clusterName) {
            const dbElement = document.getElementById(`db-${databaseName}`);
            const collectionsContainer = document.getElementById(`collections-${databaseName}`);
            const arrow = dbElement.querySelector('.expand-arrow');
            
            if (collectionsContainer.classList.contains('expanded')) {
                // Collapse
                collectionsContainer.classList.remove('expanded');
                dbElement.classList.remove('expanded');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                // Expand and load collections
                collectionsContainer.classList.add('expanded');
                dbElement.classList.add('expanded');
                arrow.style.transform = 'rotate(180deg)';
                
                // Load collections if not already loaded
                if (collectionsContainer.innerHTML.includes('Loading collections...')) {
                    try {
                        const response = await fetch(`${dashboard.baseURL}/api/collections/${clusterName}/${databaseName}`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const collections = await response.json();
                        displayCollectionsInBrowser(collections, collectionsContainer, clusterName, databaseName);
                    } catch (error) {
                        collectionsContainer.innerHTML = `<div class="error">Failed to load collections: ${error.message}</div>`;
                    }
                }
            }
        }

        function displayCollectionsInBrowser(collections, container, clusterName, databaseName) {
            if (collections.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-muted);">No collections found</div>';
                return;
            }

            const collectionsHTML = `
                <div class="collections-grid">
                    ${collections.map(collection => `
                        <div class="collection-item" onclick="selectCollectionFromBrowser('${collection.name}', '${clusterName}', '${databaseName}')">
                            <div class="collection-name">${collection.name}</div>
                            <div class="collection-stats">
                                ${collection.count !== undefined && collection.count !== 'Unknown' ? 
                                    (typeof collection.count === 'number' ? collection.count.toLocaleString() : collection.count) + ' docs' : 
                                    'Unknown'} ‚Ä¢ 
                                ${collection.size && collection.size > 0 ? `${(collection.size / 1024).toFixed(1)} KB` : 'Unknown size'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = collectionsHTML;
        }

        function selectCollectionFromBrowser(collectionName, clusterName, databaseName) {
            // Auto-fill the query tool
            document.getElementById('queryCluster').value = clusterName;
            document.getElementById('queryDatabase').value = databaseName;
            document.getElementById('queryCollection').value = collectionName;
            
            // Scroll to query tool and highlight it briefly
            const queryCard = document.getElementById('queryCollection').closest('.card');
            queryCard.scrollIntoView({ behavior: 'smooth' });
            
            // Brief highlight effect
            queryCard.style.transform = 'scale(1.02)';
            queryCard.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.3)';
            setTimeout(() => {
                queryCard.style.transform = '';
                queryCard.style.boxShadow = '';
            }, 1000);
        }

        function toggleSystemDatabases() {
            const systemDbContainer = document.getElementById('systemDatabases');
            systemDbContainer.classList.toggle('expanded');
        }

        async function executeQuery() {
            await dashboard.executeQuery();
        }

        async function checkHealth() {
            const health = await dashboard.checkAPIHealth();
            if (health) {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="success">‚úÖ API is healthy</div>
                    <div class="data-display">${JSON.stringify(health, null, 2)}</div>
                `;
            } else {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="error">‚ùå API health check failed</div>
                `;
            }
        }

        // Initialize the dashboard
        const dashboard = new MongoDBDashboard();
    </script>
</body>
</html>