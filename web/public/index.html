<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Cluster Manager - Cloud Dashboard</title>
    <style>
        :root {
            /* Light theme variables */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-tertiary: rgba(255, 255, 255, 0.9);
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-card-hover: rgba(255, 255, 255, 0.8);
            --bg-input: rgba(255, 255, 255, 0.9);
            --bg-code: #2c3e50;
            --text-primary: #333;
            --text-secondary: #2c3e50;
            --text-muted: #7f8c8d;
            --text-code: #ecf0f1;
            --text-inverse: rgba(255,255,255,0.8);
            --border-primary: rgba(255,255,255,0.2);
            --border-input: rgba(255,255,255,0.3);
            --border-focus: #667eea;
            --shadow-primary: 0 8px 32px rgba(0,0,0,0.1);
            --shadow-card: 0 20px 40px rgba(0,0,0,0.15);
            --accent-primary: #667eea;
            --accent-secondary: #f093fb;
            --accent-success: #4facfe;
            --status-success: #27ae60;
            --status-error: #e74c3c;
            --status-warning: #f39c12;
        }

        [data-theme="dark"] {
            /* Dark theme variables */
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(44, 62, 80, 0.95);
            --bg-tertiary: rgba(52, 73, 94, 0.9);
            --bg-card: rgba(52, 73, 94, 0.9);
            --bg-card-hover: rgba(44, 62, 80, 0.8);
            --bg-input: rgba(44, 62, 80, 0.9);
            --bg-code: #1e2834;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-muted: #95a5a6;
            --text-code: #ecf0f1;
            --text-inverse: rgba(236,240,241,0.8);
            --border-primary: rgba(236,240,241,0.2);
            --border-input: rgba(236,240,241,0.3);
            --border-focus: #3498db;
            --shadow-primary: 0 8px 32px rgba(0,0,0,0.3);
            --shadow-card: 0 20px 40px rgba(0,0,0,0.4);
            --accent-primary: #3498db;
            --accent-secondary: #e74c3c;
            --accent-success: #2ecc71;
            --status-success: #2ecc71;
            --status-error: #e74c3c;
            --status-warning: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-primary);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .header-content h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .header-content .subtitle {
            opacity: 0.7;
            font-size: 0.9rem;
            margin-top: 0.25rem;
            color: var(--text-muted);
        }

        .theme-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }

        .theme-selector label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .theme-selector select {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-input);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-selector select:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .status-bar {
            background: var(--bg-tertiary);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-primary);
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-error);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--status-success);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-primary);
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-card);
            background: var(--bg-card-hover);
        }

        .card h3 {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-primary) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            filter: brightness(1.1);
        }

        .btn.secondary {
            background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-secondary) 100%);
        }

        .btn.success {
            background: linear-gradient(135deg, var(--accent-success) 0%, var(--accent-success) 100%);
        }

        .cluster-list {
            list-style: none;
        }

        .cluster-item {
            background: var(--bg-input);
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-primary);
            transition: all 0.3s ease;
        }

        .cluster-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
        }

        .cluster-name {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .cluster-env {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .data-display {
            background: var(--bg-code);
            color: var(--text-code);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
            border: 1px solid var(--border-primary);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .error {
            background: var(--status-error);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: var(--status-success);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .input-group {
            margin: 1rem 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-input);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-inverse);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üçÉ MongoDB Cluster Manager</h1>
            <div class="subtitle">Cloud Dashboard - Serverless Edition</div>
        </div>
        <div class="theme-selector">
            <label for="themeSelect">Theme:</label>
            <select id="themeSelect" onchange="switchTheme()">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </div>
    </div>

    <div class="container">
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="statusText">Connecting to API...</span>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Clusters Card -->
            <div class="card">
                <h3>üåê Clusters</h3>
                <button class="btn" onclick="loadClusters()">Refresh Clusters</button>
                <div id="clustersList">
                    <div class="loading">Loading clusters...</div>
                </div>
            </div>

            <!-- Databases Card -->
            <div class="card">
                <h3>üóÑÔ∏è Databases</h3>
                <div class="input-group">
                    <label for="clusterSelect">Select Cluster:</label>
                    <select id="clusterSelect" onchange="loadDatabases()">
                        <option value="">Choose a cluster...</option>
                    </select>
                </div>
                <div id="databasesList">
                    <div class="loading">Select a cluster to view databases</div>
                </div>
            </div>

            <!-- Query Tool Card -->
            <div class="card">
                <h3>üîç Query Tool</h3>
                <div class="input-group">
                    <label for="queryCluster">Cluster:</label>
                    <select id="queryCluster">
                        <option value="">Select cluster...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="queryDatabase">Database:</label>
                    <input type="text" id="queryDatabase" placeholder="database name">
                </div>
                <div class="input-group">
                    <label for="queryCollection">Collection:</label>
                    <input type="text" id="queryCollection" placeholder="collection name">
                </div>
                <div class="input-group">
                    <label for="queryFilter">Filter (JSON):</label>
                    <textarea id="queryFilter" rows="3" placeholder='{"status": "active"}'></textarea>
                </div>
                <button class="btn success" onclick="executeQuery()">Execute Query</button>
                <div id="queryResults"></div>
            </div>

            <!-- Health Check Card -->
            <div class="card">
                <h3>‚ù§Ô∏è Health Status</h3>
                <button class="btn secondary" onclick="checkHealth()">Check API Health</button>
                <div id="healthStatus">
                    <div class="loading">Click to check health status</div>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div class="card">
            <h3>üìä Results</h3>
            <div id="resultsDisplay">
                <div class="loading">Results will appear here...</div>
            </div>
        </div>
    </div>

    <div class="footer">
        MongoDB Cluster Manager - Cloud Edition | Powered by Vercel Serverless
    </div>

    <script>
        class MongoDBDashboard {
            constructor() {
                this.baseURL = window.location.origin;
                this.clusters = [];
                this.init();
            }

            async init() {
                await this.checkAPIHealth();
                await this.loadClusters();
                this.updateConnectionStatus(true);
            }

            async checkAPIHealth() {
                try {
                    const response = await fetch(`${this.baseURL}/health`);
                    const health = await response.json();
                    this.displayResults('Health Check', health);
                    this.updateConnectionStatus(true);
                    return health;
                } catch (error) {
                    console.error('Health check failed:', error);
                    this.displayError('Health check failed: ' + error.message);
                    this.updateConnectionStatus(false);
                    return null;
                }
            }

            async loadClusters() {
                try {
                    this.updateStatus('Loading clusters...');
                    const response = await fetch(`${this.baseURL}/api/clusters`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.clusters = await response.json();
                    this.displayClusters();
                    this.populateClusterSelects();
                    this.updateConnectionStatus(true);
                } catch (error) {
                    console.error('Failed to load clusters:', error);
                    this.displayError('Failed to load clusters: ' + error.message);
                    this.updateConnectionStatus(false);
                }
            }

            async loadDatabases() {
                const clusterName = document.getElementById('clusterSelect').value;
                if (!clusterName) return;

                try {
                    this.updateStatus('Loading databases...');
                    const response = await fetch(`${this.baseURL}/api/databases/${clusterName}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const databases = await response.json();
                    this.displayDatabases(databases);
                } catch (error) {
                    console.error('Failed to load databases:', error);
                    this.displayError('Failed to load databases: ' + error.message);
                }
            }

            async executeQuery() {
                const cluster = document.getElementById('queryCluster').value;
                const database = document.getElementById('queryDatabase').value;
                const collection = document.getElementById('queryCollection').value;
                const filterText = document.getElementById('queryFilter').value;

                if (!cluster || !database || !collection) {
                    this.displayError('Please fill in cluster, database, and collection fields');
                    return;
                }

                let filter = {};
                try {
                    if (filterText.trim()) {
                        filter = JSON.parse(filterText);
                    }
                } catch (error) {
                    this.displayError('Invalid JSON in filter field');
                    return;
                }

                try {
                    this.updateStatus('Executing query...');
                    const response = await fetch(`${this.baseURL}/api/query/${cluster}/${database}/${collection}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filter: filter,
                            limit: 10
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const results = await response.json();
                    this.displayResults('Query Results', results);
                } catch (error) {
                    console.error('Query failed:', error);
                    this.displayError('Query failed: ' + error.message);
                }
            }

            displayClusters() {
                const container = document.getElementById('clustersList');
                
                if (this.clusters.length === 0) {
                    container.innerHTML = '<div class="loading">No clusters configured</div>';
                    return;
                }

                const clustersHTML = this.clusters.map(cluster => `
                    <div class="cluster-item">
                        <div class="cluster-name">${cluster.name || 'Unnamed Cluster'}</div>
                        <div class="cluster-env">Environment: ${cluster.environment || 'Unknown'}</div>
                    </div>
                `).join('');

                container.innerHTML = clustersHTML;
            }

            displayDatabases(databases) {
                const container = document.getElementById('databasesList');
                
                if (databases.length === 0) {
                    container.innerHTML = '<div class="loading">No databases found</div>';
                    return;
                }

                const databasesHTML = databases.map(db => `
                    <div class="cluster-item">
                        <div class="cluster-name">${db.name}</div>
                        <div class="cluster-env">Size: ${db.sizeOnDisk ? (db.sizeOnDisk / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown'}</div>
                    </div>
                `).join('');

                container.innerHTML = databasesHTML;
            }

            populateClusterSelects() {
                const selects = ['clusterSelect', 'queryCluster'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    // Clear existing options except the first
                    select.innerHTML = select.children[0].outerHTML;
                    
                    this.clusters.forEach(cluster => {
                        const option = document.createElement('option');
                        option.value = cluster.name || cluster.id || 'unknown';
                        option.textContent = cluster.name || cluster.id || 'Unknown Cluster';
                        select.appendChild(option);
                    });
                });
            }

            displayResults(title, data) {
                const container = document.getElementById('resultsDisplay');
                container.innerHTML = `
                    <h4>${title}</h4>
                    <div class="data-display">${JSON.stringify(data, null, 2)}</div>
                `;
            }

            displayError(message) {
                const container = document.getElementById('resultsDisplay');
                container.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            }

            displaySuccess(message) {
                const container = document.getElementById('resultsDisplay');
                container.innerHTML = `<div class="success">‚úÖ ${message}</div>`;
            }

            updateStatus(message) {
                document.getElementById('statusText').textContent = message;
            }

            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected to MongoDB Manager API';
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Disconnected from API';
                }
            }
        }

        // Theme Management
        class ThemeManager {
            constructor() {
                this.currentTheme = 'system';
                this.init();
            }

            init() {
                // Load saved theme preference
                const savedTheme = localStorage.getItem('mongodb-manager-theme') || 'system';
                this.setTheme(savedTheme);
                
                // Update select value
                document.getElementById('themeSelect').value = savedTheme;

                // Listen for system theme changes
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                        if (this.currentTheme === 'system') {
                            this.applySystemTheme();
                        }
                    });
                }
            }

            setTheme(theme) {
                this.currentTheme = theme;
                localStorage.setItem('mongodb-manager-theme', theme);

                if (theme === 'system') {
                    this.applySystemTheme();
                } else {
                    this.applyTheme(theme);
                }
            }

            applySystemTheme() {
                const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                this.applyTheme(isDark ? 'dark' : 'light');
            }

            applyTheme(theme) {
                const html = document.documentElement;
                
                if (theme === 'dark') {
                    html.setAttribute('data-theme', 'dark');
                } else {
                    html.removeAttribute('data-theme');
                }
            }

            toggleTheme() {
                const themes = ['system', 'light', 'dark'];
                const currentIndex = themes.indexOf(this.currentTheme);
                const nextTheme = themes[(currentIndex + 1) % themes.length];
                this.setTheme(nextTheme);
                document.getElementById('themeSelect').value = nextTheme;
            }
        }

        // Initialize theme manager
        const themeManager = new ThemeManager();

        // Global theme switch function
        function switchTheme() {
            const select = document.getElementById('themeSelect');
            themeManager.setTheme(select.value);
        }

        // Global functions for button clicks
        async function loadClusters() {
            await dashboard.loadClusters();
        }

        async function loadDatabases() {
            await dashboard.loadDatabases();
        }

        async function executeQuery() {
            await dashboard.executeQuery();
        }

        async function checkHealth() {
            const health = await dashboard.checkAPIHealth();
            if (health) {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="success">‚úÖ API is healthy</div>
                    <div class="data-display">${JSON.stringify(health, null, 2)}</div>
                `;
            } else {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="error">‚ùå API health check failed</div>
                `;
            }
        }

        // Initialize the dashboard
        const dashboard = new MongoDBDashboard();
    </script>
</body>
</html>