<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Cluster Manager - Cloud Dashboard</title>
    <style>
        :root {
            /* Light theme variables */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-tertiary: rgba(255, 255, 255, 0.9);
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-card-hover: rgba(255, 255, 255, 0.8);
            --bg-input: rgba(255, 255, 255, 0.9);
            --bg-code: #2c3e50;
            --text-primary: #333;
            --text-secondary: #2c3e50;
            --text-muted: #7f8c8d;
            --text-code: #ecf0f1;
            --text-inverse: rgba(255,255,255,0.8);
            --border-primary: rgba(255,255,255,0.2);
            --border-input: rgba(255,255,255,0.3);
            --border-focus: #667eea;
            --shadow-primary: 0 8px 32px rgba(0,0,0,0.1);
            --shadow-card: 0 20px 40px rgba(0,0,0,0.15);
            --accent-primary: #667eea;
            --accent-secondary: #f093fb;
            --accent-success: #4facfe;
            --status-success: #27ae60;
            --status-error: #e74c3c;
            --status-warning: #f39c12;
        }

        [data-theme="dark"] {
            /* Dark theme variables */
            --bg-primary: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-secondary: rgba(44, 62, 80, 0.95);
            --bg-tertiary: rgba(52, 73, 94, 0.9);
            --bg-card: rgba(52, 73, 94, 0.9);
            --bg-card-hover: rgba(44, 62, 80, 0.8);
            --bg-input: rgba(44, 62, 80, 0.9);
            --bg-code: #1e2834;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-muted: #95a5a6;
            --text-code: #ecf0f1;
            --text-inverse: rgba(236,240,241,0.8);
            --border-primary: rgba(236,240,241,0.2);
            --border-input: rgba(236,240,241,0.3);
            --border-focus: #3498db;
            --shadow-primary: 0 8px 32px rgba(0,0,0,0.3);
            --shadow-card: 0 20px 40px rgba(0,0,0,0.4);
            --accent-primary: #3498db;
            --accent-secondary: #e74c3c;
            --accent-success: #2ecc71;
            --status-success: #2ecc71;
            --status-error: #e74c3c;
            --status-warning: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-primary);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .header-content h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .header-content .subtitle {
            opacity: 0.7;
            font-size: 0.9rem;
            margin-top: 0.25rem;
            color: var(--text-muted);
        }

        .theme-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }

        .theme-selector label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .theme-selector select {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-input);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-selector select:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .status-bar {
            background: var(--bg-tertiary);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-primary);
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-error);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--status-success);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-primary);
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-card);
            background: var(--bg-card-hover);
        }

        .card h3 {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-primary) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            filter: brightness(1.1);
        }

        .btn.secondary {
            background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-secondary) 100%);
        }

        .btn.success {
            background: linear-gradient(135deg, var(--accent-success) 0%, var(--accent-success) 100%);
        }

        .cluster-list {
            list-style: none;
        }

        .cluster-item {
            background: var(--bg-input);
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-primary);
            transition: all 0.3s ease;
        }

        .cluster-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
        }

        .cluster-item[onclick] {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cluster-item[onclick]:hover {
            background: var(--bg-card-hover);
            transform: translateX(8px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .database-browser {
            grid-column: 1 / -1; /* Full width */
        }

        .database-item {
            background: var(--bg-input);
            margin: 0.5rem 0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-success);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .database-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
        }

        .database-item.expanded {
            border-left-color: var(--accent-primary);
            background: var(--bg-card);
        }

        .database-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .database-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .database-info {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .collections-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-primary);
            display: none;
        }

        .collections-container.expanded {
            display: block;
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .collection-item {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid var(--accent-secondary);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .collection-item:hover {
            background: var(--bg-card-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .collection-name {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .collection-stats {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .document-manager {
            grid-column: 1 / -1; /* Full width */
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .document-controls {
            display: flex;
            gap: 0.5rem;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed;
        }

        .document-table-container {
            overflow-x: auto;
            max-width: 100%;
            border-radius: 8px;
        }

        .document-table th,
        .document-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .document-table th {
            width: auto;
            min-width: 100px;
            max-width: 150px;
        }

        .document-table th:first-child {
            width: 120px;
            min-width: 120px;
        }

        .document-table th:last-child {
            width: 120px;
            min-width: 120px;
        }

        .document-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .document-table td {
            color: var(--text-primary);
        }

        .document-table tr:hover {
            background: var(--bg-card-hover);
        }

        .document-actions {
            display: flex;
            gap: 0.25rem;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .action-btn.edit {
            color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .action-btn.delete {
            color: var(--status-error);
            background: rgba(231, 76, 60, 0.1);
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .json-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            word-break: break-all;
            position: relative;
        }

        .json-cell:hover {
            background: var(--bg-card-hover);
        }

        @media (max-width: 768px) {
            .json-cell {
                max-width: 100px;
            }
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            flex-wrap: wrap;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-card);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            color: var(--text-secondary);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .json-editor {
            width: 100%;
            min-height: 300px;
            padding: 1rem;
            border: 2px solid var(--border-input);
            border-radius: 8px;
            background: var(--bg-code);
            color: var(--text-code);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            resize: vertical;
        }

        .json-editor:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .cluster-name {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .cluster-env {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .data-display {
            background: var(--bg-code);
            color: var(--text-code);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
            border: 1px solid var(--border-primary);
            word-break: break-all;
            line-height: 1.4;
        }

        .results-container {
            margin-top: 1rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 1rem;
        }

        .results-title {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .results-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .results-controls button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .results-controls button:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }

        .results-controls button.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .results-summary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .results-cards {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: 1fr;
        }

        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }

        .result-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }

        .result-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .result-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .result-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .result-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .result-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .result-field {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
        }

        .result-field-key {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .result-field-value {
            color: var(--text-primary);
            font-family: 'Monaco', 'Menlo', monospace;
            background: var(--bg-tertiary);
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-full {
            display: none;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-primary);
        }

        .result-card.expanded .result-full {
            display: block;
        }

        .result-json {
            background: var(--bg-code);
            color: var(--text-code);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 0.75rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow: auto;
            line-height: 1.3;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .error {
            background: var(--status-error);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success {
            background: var(--status-success);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .input-group {
            margin: 1rem 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-input);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-inverse);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-form">
            <h2>üîí MongoDB Manager Access</h2>
            <div class="auth-warning">
                ‚ö†Ô∏è <strong>Security Notice:</strong> This dashboard provides full access to your MongoDB database. Enter your MongoDB Atlas credentials to continue.
            </div>
            <div id="credentialsInfo" style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
                üîÑ Loading credentials from MongoDB connection string...
            </div>
            <input type="text" id="authUsername" placeholder="Loading username..." onkeypress="if(event.key==='Enter') document.getElementById('authPassword').focus()" />
            <input type="password" id="authPassword" placeholder="Enter your MongoDB password" onkeypress="if(event.key==='Enter') authenticate()" />
            <button onclick="authenticate()">üöÄ Access Dashboard</button>
            <div id="authError" class="auth-error"></div>
        </div>
    </div>

    <div class="header">
        <div class="header-content">
            <h1>üçÉ MongoDB Cluster Manager</h1>
            <div class="subtitle">Cloud Dashboard - Serverless Edition</div>
            <div id="userWelcome" style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;"></div>
        </div>
        <div class="theme-selector">
            <label for="themeSelect">Theme:</label>
            <select id="themeSelect" onchange="switchTheme()">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
            <button onclick="logout()" style="margin-left: 1rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;" class="btn secondary">üö™ Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="statusText">Connecting to API...</span>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Clusters Card -->
            <div class="card">
                <h3>üåê Clusters</h3>
                <button class="btn" onclick="loadClusters()">Refresh Clusters</button>
                <div id="clustersList">
                    <div class="loading">Loading clusters...</div>
                </div>
            </div>

            <!-- Database Browser Card -->
            <div class="card database-browser">
                <h3>üóÑÔ∏è Database Browser</h3>
                <div id="databaseBrowser">
                    <div class="loading">Loading your databases...</div>
                </div>
            </div>

            <!-- Document Manager Card -->
            <div class="card document-manager">
                <div class="document-header">
                    <h3 id="documentTitle">üìÑ Document Manager</h3>
                    <div class="document-controls">
                        <button class="btn success" onclick="showCreateDialog()" id="createBtn" style="display: none;">+ Add Document</button>
                        <button class="btn" onclick="refreshDocuments()" id="refreshBtn" style="display: none;">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div id="documentContent">
                    <div class="loading">Select a collection to view and manage documents</div>
                </div>
                
                <!-- Pagination -->
                <div id="paginationControls" style="display: none;">
                    <div class="pagination">
                        <div class="pagination-info">
                            <span id="pageInfo">Page 1 of 1</span>
                        </div>
                        <div class="pagination-controls">
                            <button class="btn" onclick="changePage(-1)" id="prevBtn">‚Äπ Previous</button>
                            <button class="btn" onclick="changePage(1)" id="nextBtn">Next ‚Ä∫</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Check Card -->
            <div class="card">
                <h3>‚ù§Ô∏è Health Status</h3>
                <button class="btn secondary" onclick="checkHealth()">Check API Health</button>
                <div id="healthStatus">
                    <div class="loading">Click to check health status</div>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div class="card">
            <h3>üìä Results</h3>
            <div id="resultsDisplay">
                <div class="loading">Results will appear here...</div>
            </div>
        </div>
    </div>

    <div class="footer">
        MongoDB Cluster Manager - Cloud Edition | Powered by Vercel Serverless
    </div>

    <!-- CRUD Modals -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Document</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="input-group">
                <label for="documentEditor">Document JSON:</label>
                <textarea id="documentEditor" class="json-editor" placeholder='{\n  "field": "value",\n  "number": 123,\n  "active": true\n}'></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn success" onclick="saveDocument()" id="saveBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        class MongoDBDashboard {
            constructor() {
                this.baseURL = window.location.origin;
                this.clusters = [];
                this.currentCollection = null;
                this.currentPage = 1;
                this.documentsPerPage = parseInt(localStorage.getItem('mongodb-manager-page-size')) || 20;
                this.documentViewMode = localStorage.getItem('mongodb-manager-document-view') || 'cards';
                this.resultsViewMode = localStorage.getItem('mongodb-manager-results-view') || 'cards';
                this.lastQueryResults = null;
                this.editingDocument = null;
                this.init();
            }

            async init() {
                await this.checkAPIHealth();
                await this.loadClusters();
                await this.autoLoadDatabaseBrowser(); // Automatically load the integrated browser
                this.updateConnectionStatus(true);
            }

            // Helper method to make authenticated API calls
            async authenticatedFetch(url, options = {}) {
                const username = sessionStorage.getItem('mongodb-manager-user') || 'admin';
                const defaultHeaders = {
                    'Content-Type': 'application/json',
                    'X-API-Key': `${username}-mongodb-access`
                };
                
                const config = {
                    ...options,
                    headers: {
                        ...defaultHeaders,
                        ...options.headers
                    }
                };
                
                return fetch(url, config);
            }

            async checkAPIHealth() {
                try {
                    const response = await fetch(`${this.baseURL}/health`);
                    const health = await response.json();
                    this.displayResults('Health Check', health);
                    this.updateConnectionStatus(true);
                    return health;
                } catch (error) {
                    console.error('Health check failed:', error);
                    this.displayError('Health check failed: ' + error.message);
                    this.updateConnectionStatus(false);
                    return null;
                }
            }

            async loadClusters() {
                try {
                    this.updateStatus('Loading clusters...');
                    const response = await this.authenticatedFetch(`${this.baseURL}/api/clusters`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.clusters = await response.json();
                    this.displayClusters();
                    this.updateConnectionStatus(true);
                } catch (error) {
                    console.error('Failed to load clusters:', error);
                    this.displayError('Failed to load clusters: ' + error.message);
                    this.updateConnectionStatus(false);
                }
            }

            async autoLoadDatabaseBrowser() {
                // Automatically load the integrated database browser
                if (this.clusters.length === 0) {
                    document.getElementById('databaseBrowser').innerHTML = '<div class="loading">No clusters available</div>';
                    return;
                }

                // Use the first available cluster (usually Cluster0)
                const primaryCluster = this.clusters[0];
                await this.loadDatabaseBrowser(primaryCluster.name);
            }

            async loadDatabaseBrowser(clusterName) {
                try {
                    this.updateStatus('Loading database browser...');
                    const response = await this.authenticatedFetch(`${this.baseURL}/api/databases/${clusterName}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const databases = await response.json();
                    this.displayDatabaseBrowser(databases, clusterName);
                } catch (error) {
                    console.error('Failed to load database browser:', error);
                    document.getElementById('databaseBrowser').innerHTML = `<div class="error">Failed to load databases: ${error.message}</div>`;
                }
            }

            displayDatabaseBrowser(databases, clusterName) {
                const container = document.getElementById('databaseBrowser');
                
                if (databases.length === 0) {
                    container.innerHTML = '<div class="loading">No databases found</div>';
                    return;
                }

                // Filter out system databases by default, but show them as expandable
                const userDatabases = databases.filter(db => !['admin', 'local', 'config'].includes(db.name));
                const systemDatabases = databases.filter(db => ['admin', 'local', 'config'].includes(db.name));

                const databasesHTML = [
                    ...userDatabases.map(db => this.createDatabaseHTML(db, clusterName)),
                    systemDatabases.length > 0 ? `
                        <div class="database-item" onclick="toggleSystemDatabases()">
                            <div class="database-header">
                                <div>
                                    <div class="database-name">üìÅ System Databases</div>
                                    <div class="database-info">${systemDatabases.length} system databases (admin, local, config)</div>
                                </div>
                                <div style="color: var(--text-muted);">‚ñº</div>
                            </div>
                            <div class="collections-container" id="systemDatabases">
                                ${systemDatabases.map(db => this.createDatabaseHTML(db, clusterName)).join('')}
                            </div>
                        </div>
                    ` : ''
                ].join('');

                container.innerHTML = databasesHTML;
            }

            createDatabaseHTML(database, clusterName) {
                const sizeInfo = database.sizeOnDisk ? `${(database.sizeOnDisk / 1024 / 1024).toFixed(2)} MB` : 'Unknown size';
                
                return `
                    <div class="database-item" onclick="toggleDatabase('${database.name}', '${clusterName}')" id="db-${database.name}">
                        <div class="database-header">
                            <div>
                                <div class="database-name">${database.name}</div>
                                <div class="database-info">${sizeInfo} ‚Ä¢ Click to explore collections</div>
                            </div>
                            <div style="color: var(--text-muted); transition: transform 0.3s ease;" class="expand-arrow">‚ñº</div>
                        </div>
                        <div class="collections-container" id="collections-${database.name}">
                            <div class="loading" style="text-align: center; padding: 1rem; color: var(--text-muted);">Loading collections...</div>
                        </div>
                    </div>
                `;
            }

            // Legacy method - no longer used with new integrated browser


            displayClusters() {
                const container = document.getElementById('clustersList');
                
                if (this.clusters.length === 0) {
                    container.innerHTML = '<div class="loading">No clusters configured</div>';
                    return;
                }

                const clustersHTML = this.clusters.map(cluster => `
                    <div class="cluster-item">
                        <div class="cluster-name">${cluster.name || 'Unnamed Cluster'}</div>
                        <div class="cluster-env">
                            ${cluster.description || 'MongoDB Cluster'} ‚Ä¢ 
                            ${cluster.environment || 'Unknown'} ‚Ä¢ 
                            Status: ${cluster.status || 'Unknown'}
                            ${cluster.totalDatabases ? ` ‚Ä¢ ${cluster.totalDatabases} databases` : ''}
                            ${cluster.version ? ` ‚Ä¢ v${cluster.version}` : ''}
                        </div>
                        ${cluster.error ? `<div style="color: var(--status-error); font-size: 0.8rem; margin-top: 0.5rem;">Error: ${cluster.error}</div>` : ''}
                    </div>
                `).join('');

                container.innerHTML = clustersHTML;
            }



            displayResults(title, data) {
                const container = document.getElementById('resultsDisplay');
                
                // Store results for view toggling
                this.lastQueryResults = data;
                
                // Check if data looks like query results with documents
                if (data && data.documents && Array.isArray(data.documents)) {
                    this.displayQueryResults(title, data, container);
                } else {
                    // Fallback to simple JSON display
                    container.innerHTML = `
                        <div class="results-container">
                            <div class="results-header">
                                <h4 class="results-title">${title}</h4>
                                <div class="results-controls">
                                    <button onclick="this.parentElement.parentElement.nextElementSibling.scrollTop = 0">‚¨ÜÔ∏è Top</button>
                                </div>
                            </div>
                            <div class="data-display">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                }
            }

            displayQueryResults(title, data, container) {
                const { documents, totalCount, returnedCount } = data;
                
                if (!documents || documents.length === 0) {
                    container.innerHTML = `
                        <div class="results-container">
                            <h4 class="results-title">${title}</h4>
                            <div class="results-summary">
                                üìÑ No documents found matching your query
                            </div>
                        </div>
                    `;
                    return;
                }

                const resultsHTML = `
                    <div class="results-container">
                        <div class="results-header">
                            <h4 class="results-title">${title}</h4>
                            <div class="results-controls">
                                <button onclick="dashboard.toggleResultsView('cards')" class="${this.resultsViewMode !== 'json' ? 'active' : ''}">üìã Cards</button>
                                <button onclick="dashboard.toggleResultsView('json')" class="${this.resultsViewMode === 'json' ? 'active' : ''}">üîç JSON</button>
                            </div>
                        </div>
                        
                        <div class="results-summary">
                            üìä Found ${totalCount || returnedCount} document${(totalCount || returnedCount) !== 1 ? 's' : ''} 
                            ${returnedCount !== totalCount ? `(showing ${returnedCount})` : ''}
                        </div>

                        <div id="results-content">
                            ${this.resultsViewMode === 'json' ? 
                                `<div class="data-display">${JSON.stringify(data, null, 2)}</div>` :
                                this.renderResultCards(documents)
                            }
                        </div>
                    </div>
                `;

                container.innerHTML = resultsHTML;
            }

            renderResultCards(documents) {
                return `
                    <div class="results-cards">
                        ${documents.map((doc, index) => this.createResultCard(doc, index)).join('')}
                    </div>
                `;
            }

            createResultCard(doc, index) {
                const docId = doc._id || `result-${index}`;
                const otherFields = Object.entries(doc).filter(([key]) => key !== '_id').slice(0, 3);
                
                return `
                    <div class="result-card" id="result-card-${index}">
                        <div class="result-card-header">
                            <div class="result-id">üÜî ${docId}</div>
                            <button class="result-toggle" onclick="dashboard.toggleResultCard(${index})">
                                üìÑ Details
                            </button>
                        </div>
                        
                        <div class="result-preview">
                            ${otherFields.map(([key, value]) => `
                                <div class="result-field">
                                    <span class="result-field-key">${key}:</span>
                                    <span class="result-field-value" title="${this.formatCellValue(value)}">
                                        ${this.formatPreviewValue(value)}
                                    </span>
                                </div>
                            `).join('')}
                            ${Object.keys(doc).length > 4 ? `
                                <div class="result-field">
                                    <span class="result-field-key">...</span>
                                    <span class="result-field-value">+${Object.keys(doc).length - 4} more</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="result-full" id="result-full-${index}">
                            <div class="result-json">${JSON.stringify(doc, null, 2)}</div>
                        </div>
                    </div>
                `;
            }

            toggleResultsView(mode) {
                this.resultsViewMode = mode;
                localStorage.setItem('mongodb-manager-results-view', mode);
                
                // Re-render current results if they exist
                const resultsContent = document.getElementById('results-content');
                if (resultsContent && this.lastQueryResults) {
                    if (mode === 'json') {
                        resultsContent.innerHTML = `<div class="data-display">${JSON.stringify(this.lastQueryResults, null, 2)}</div>`;
                    } else if (this.lastQueryResults.documents) {
                        resultsContent.innerHTML = this.renderResultCards(this.lastQueryResults.documents);
                    }
                    
                    // Update button states
                    const buttons = document.querySelectorAll('.results-controls button');
                    buttons.forEach(btn => {
                        btn.classList.remove('active');
                        if ((mode === 'cards' && btn.textContent.includes('Cards')) || 
                            (mode === 'json' && btn.textContent.includes('JSON'))) {
                            btn.classList.add('active');
                        }
                    });
                }
            }

            toggleResultCard(index) {
                const card = document.getElementById(`result-card-${index}`);
                if (card) {
                    card.classList.toggle('expanded');
                }
            }

            displayError(message) {
                const container = document.getElementById('resultsDisplay');
                container.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            }

            displaySuccess(message) {
                const container = document.getElementById('resultsDisplay');
                container.innerHTML = `<div class="success">‚úÖ ${message}</div>`;
            }

            updateStatus(message) {
                document.getElementById('statusText').textContent = message;
            }

            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected to MongoDB Manager API';
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Disconnected from API';
                }
            }

            // Document Management Methods
            async loadDocuments(clusterName, databaseName, collectionName, page = 1) {
                this.currentCollection = { cluster: clusterName, database: databaseName, collection: collectionName };
                this.currentPage = page;
                
                try {
                    this.updateStatus(`Loading documents from ${collectionName}...`);
                    const response = await this.authenticatedFetch(`${this.baseURL}/api/documents/${clusterName}/${databaseName}/${collectionName}?page=${page}&limit=${this.documentsPerPage}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.displayDocuments(data, collectionName);
                    this.updatePagination(data.pagination);
                    
                    // Show controls
                    document.getElementById('createBtn').style.display = 'block';
                    document.getElementById('refreshBtn').style.display = 'block';
                    document.getElementById('paginationControls').style.display = 'block';
                    document.getElementById('documentTitle').textContent = `üìÑ ${collectionName} (${data.pagination.total} documents)`;
                    
                } catch (error) {
                    console.error('Failed to load documents:', error);
                    this.displayError('Failed to load documents: ' + error.message);
                }
            }

            displayDocuments(data, collectionName) {
                const container = document.getElementById('documentContent');
                
                if (data.documents.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <p>No documents found in ${collectionName}</p>
                            <button class="btn success" onclick="showCreateDialog()">+ Add First Document</button>
                        </div>
                    `;
                    return;
                }

                // Get all unique keys from documents for table headers
                const allKeys = new Set(['_id']);
                data.documents.forEach(doc => {
                    Object.keys(doc).forEach(key => allKeys.add(key));
                });
                const keys = Array.from(allKeys);

                // Limit to first 6 columns to prevent horizontal overflow
                const displayKeys = keys.slice(0, 6);
                const hasMoreKeys = keys.length > 6;

                const tableHTML = `
                    <div class="view-controls">
                        <div class="view-toggle">
                            <button onclick="dashboard.setDocumentView('cards')">üìã Cards</button>
                            <button class="active" onclick="dashboard.setDocumentView('table')">üìä Table</button>
                        </div>
                        <div class="page-size-control">
                            <label>Show:</label>
                            <select onchange="dashboard.changePageSize(this.value)">
                                <option value="10" ${this.documentsPerPage === 10 ? 'selected' : ''}>10</option>
                                <option value="20" ${this.documentsPerPage === 20 ? 'selected' : ''}>20</option>
                                <option value="50" ${this.documentsPerPage === 50 ? 'selected' : ''}>50</option>
                                <option value="100" ${this.documentsPerPage === 100 ? 'selected' : ''}>100</option>
                            </select>
                        </div>
                    </div>
                    <div class="document-table-container">
                        <table class="document-table">
                            <thead>
                                <tr>
                                    ${displayKeys.map(key => `<th title="${key}">${key.length > 12 ? key.substring(0, 12) + '...' : key}</th>`).join('')}
                                    ${hasMoreKeys ? `<th title="${keys.length - 6} additional fields hidden">+${keys.length - 6} more</th>` : ''}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.documents.map(doc => `
                                    <tr>
                                        ${displayKeys.map(key => `
                                            <td class="json-cell" title="${key}: ${this.formatCellValue(doc[key])}">
                                                ${this.formatCellValue(doc[key])}
                                            </td>
                                        `).join('')}
                                        ${hasMoreKeys ? `<td class="json-cell" title="Click edit to view all ${keys.length} fields">...</td>` : ''}
                                        <td>
                                            <div class="document-actions">
                                                <button class="action-btn edit" onclick="editDocument('${doc._id}')" title="Edit">‚úèÔ∏è</button>
                                                <button class="action-btn delete" onclick="deleteDocument('${doc._id}')" title="Delete">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = tableHTML;
            }

            formatCellValue(value) {
                if (value === null) return 'null';
                if (value === undefined) return 'undefined';
                if (typeof value === 'object') {
                    const jsonStr = JSON.stringify(value);
                    if (Array.isArray(value)) {
                        return `[${value.length} items]`;
                    }
                    return jsonStr.length > 20 ? jsonStr.substring(0, 20) + '...' : jsonStr;
                }
                if (typeof value === 'string') {
                    // Handle URLs and long strings differently
                    if (value.startsWith('http') || value.startsWith('/')) {
                        const parts = value.split('/');
                        return parts.length > 3 ? `.../${parts[parts.length-1]}` : value;
                    }
                    return value.length > 20 ? value.substring(0, 20) + '...' : value;
                }
                if (typeof value === 'boolean') {
                    return value ? '\u2713 true' : '\u2717 false';
                }
                return String(value);
            }

            formatPreviewValue(value) {
                if (value === null) return 'null';
                if (value === undefined) return 'undefined';
                if (typeof value === 'object') {
                    if (Array.isArray(value)) {
                        return `[${value.length}]`;
                    }
                    return Object.keys(value).length > 0 ? `{${Object.keys(value).length}}` : '{}';
                }
                if (typeof value === 'string') {
                    if (value.startsWith('http') || value.startsWith('/')) {
                        return '\ud83d\udd17 link';
                    }
                    return value.length > 12 ? value.substring(0, 12) + '...' : value;
                }
                if (typeof value === 'boolean') {
                    return value ? '\u2713' : '\u2717';
                }
                return String(value);
            }

            updatePagination(pagination) {
                document.getElementById('pageInfo').textContent = `Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)`;
                document.getElementById('prevBtn').disabled = pagination.page <= 1;
                document.getElementById('nextBtn').disabled = pagination.page >= pagination.pages;
            }

            async createDocument(documentData) {
                try {
                    const response = await this.authenticatedFetch(`${this.baseURL}/api/documents/${this.currentCollection.cluster}/${this.currentCollection.database}/${this.currentCollection.collection}`, {
                        method: 'POST',
                        body: JSON.stringify(documentData)
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    await this.loadDocuments(this.currentCollection.cluster, this.currentCollection.database, this.currentCollection.collection, this.currentPage);
                    this.displaySuccess('Document created successfully!');
                } catch (error) {
                    console.error('Error creating document:', error);
                    throw error;
                }
            }

            async updateDocument(documentId, documentData) {
                try {
                    const response = await fetch(`${this.baseURL}/api/documents/${this.currentCollection.cluster}/${this.currentCollection.database}/${this.currentCollection.collection}/${documentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(documentData)
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    await this.loadDocuments(this.currentCollection.cluster, this.currentCollection.database, this.currentCollection.collection, this.currentPage);
                    this.displaySuccess('Document updated successfully!');
                } catch (error) {
                    console.error('Error updating document:', error);
                    throw error;
                }
            }

            async deleteDocument(documentId) {
                if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.baseURL}/api/documents/${this.currentCollection.cluster}/${this.currentCollection.database}/${this.currentCollection.collection}/${documentId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    await this.loadDocuments(this.currentCollection.cluster, this.currentCollection.database, this.currentCollection.collection, this.currentPage);
                    this.displaySuccess('Document deleted successfully!');
                } catch (error) {
                    console.error('Error deleting document:', error);
                    this.displayError('Failed to delete document: ' + error.message);
                }
            }
        }

        // Theme Management
        class ThemeManager {
            constructor() {
                this.currentTheme = 'system';
                this.init();
            }

            init() {
                // Load saved theme preference
                const savedTheme = localStorage.getItem('mongodb-manager-theme') || 'system';
                this.setTheme(savedTheme);
                
                // Update select value
                document.getElementById('themeSelect').value = savedTheme;

                // Listen for system theme changes
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                        if (this.currentTheme === 'system') {
                            this.applySystemTheme();
                        }
                    });
                }
            }

            setTheme(theme) {
                this.currentTheme = theme;
                localStorage.setItem('mongodb-manager-theme', theme);

                if (theme === 'system') {
                    this.applySystemTheme();
                } else {
                    this.applyTheme(theme);
                }
            }

            applySystemTheme() {
                const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                this.applyTheme(isDark ? 'dark' : 'light');
            }

            applyTheme(theme) {
                const html = document.documentElement;
                
                if (theme === 'dark') {
                    html.setAttribute('data-theme', 'dark');
                } else {
                    html.removeAttribute('data-theme');
                }
            }

            toggleTheme() {
                const themes = ['system', 'light', 'dark'];
                const currentIndex = themes.indexOf(this.currentTheme);
                const nextTheme = themes[(currentIndex + 1) % themes.length];
                this.setTheme(nextTheme);
                document.getElementById('themeSelect').value = nextTheme;
            }
        }

        // Initialize theme manager
        const themeManager = new ThemeManager();

        // Global theme switch function
        function switchTheme() {
            const select = document.getElementById('themeSelect');
            themeManager.setTheme(select.value);
        }

        // Global functions for button clicks
        async function loadClusters() {
            await dashboard.loadClusters();
        }


        async function toggleDatabase(databaseName, clusterName) {
            const dbElement = document.getElementById(`db-${databaseName}`);
            const collectionsContainer = document.getElementById(`collections-${databaseName}`);
            const arrow = dbElement.querySelector('.expand-arrow');
            
            if (collectionsContainer.classList.contains('expanded')) {
                // Collapse
                collectionsContainer.classList.remove('expanded');
                dbElement.classList.remove('expanded');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                // Expand and load collections
                collectionsContainer.classList.add('expanded');
                dbElement.classList.add('expanded');
                arrow.style.transform = 'rotate(180deg)';
                
                // Load collections if not already loaded
                if (collectionsContainer.innerHTML.includes('Loading collections...')) {
                    try {
                        const response = await fetch(`${dashboard.baseURL}/api/collections/${clusterName}/${databaseName}`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const collections = await response.json();
                        displayCollectionsInBrowser(collections, collectionsContainer, clusterName, databaseName);
                    } catch (error) {
                        collectionsContainer.innerHTML = `<div class="error">Failed to load collections: ${error.message}</div>`;
                    }
                }
            }
        }

        function displayCollectionsInBrowser(collections, container, clusterName, databaseName) {
            if (collections.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-muted);">No collections found</div>';
                return;
            }

            const collectionsHTML = `
                <div class="collections-grid">
                    ${collections.map(collection => `
                        <div class="collection-item" onclick="selectCollectionFromBrowser('${collection.name}', '${clusterName}', '${databaseName}')">
                            <div class="collection-name">${collection.name}</div>
                            <div class="collection-stats">
                                ${collection.count !== undefined && collection.count !== 'Unknown' ? 
                                    (typeof collection.count === 'number' ? collection.count.toLocaleString() : collection.count) + ' docs' : 
                                    'Unknown'} ‚Ä¢ 
                                ${collection.size && collection.size > 0 ? `${(collection.size / 1024).toFixed(1)} KB` : 'Unknown size'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = collectionsHTML;
        }

        function selectCollectionFromBrowser(collectionName, clusterName, databaseName) {
            // Load documents in the document manager
            dashboard.loadDocuments(clusterName, databaseName, collectionName);
            
            // Scroll to document manager and highlight it briefly
            const docCard = document.querySelector('.document-manager');
            docCard.scrollIntoView({ behavior: 'smooth' });
            
            // Brief highlight effect
            docCard.style.transform = 'scale(1.01)';
            docCard.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.3)';
            setTimeout(() => {
                docCard.style.transform = '';
                docCard.style.boxShadow = '';
            }, 1000);
        }

        // CRUD Global Functions
        async function refreshDocuments() {
            if (dashboard.currentCollection) {
                await dashboard.loadDocuments(
                    dashboard.currentCollection.cluster,
                    dashboard.currentCollection.database,
                    dashboard.currentCollection.collection,
                    dashboard.currentPage
                );
            }
        }

        function changePage(direction) {
            const newPage = dashboard.currentPage + direction;
            if (newPage >= 1 && dashboard.currentCollection) {
                dashboard.loadDocuments(
                    dashboard.currentCollection.cluster,
                    dashboard.currentCollection.database,
                    dashboard.currentCollection.collection,
                    newPage
                );
            }
        }

        function showCreateDialog() {
            document.getElementById('modalTitle').textContent = 'Add New Document';
            document.getElementById('documentEditor').value = '{\n  \n}';
            document.getElementById('saveBtn').textContent = 'Create';
            dashboard.editingDocument = null;
            document.getElementById('documentModal').classList.add('show');
        }

        async function editDocument(documentId) {
            // Find the document in current loaded documents
            const container = document.getElementById('documentContent');
            const table = container.querySelector('.document-table');
            if (!table) return;

            try {
                // Get fresh document data
                const response = await fetch(`${dashboard.baseURL}/api/documents/${dashboard.currentCollection.cluster}/${dashboard.currentCollection.database}/${dashboard.currentCollection.collection}?filter={"_id":"${documentId}"}&limit=1`);
                const data = await response.json();
                
                if (data.documents.length > 0) {
                    const doc = data.documents[0];
                    document.getElementById('modalTitle').textContent = 'Edit Document';
                    document.getElementById('documentEditor').value = JSON.stringify(doc, null, 2);
                    document.getElementById('saveBtn').textContent = 'Update';
                    dashboard.editingDocument = documentId;
                    document.getElementById('documentModal').classList.add('show');
                }
            } catch (error) {
                dashboard.displayError('Failed to load document for editing: ' + error.message);
            }
        }

        async function deleteDocument(documentId) {
            await dashboard.deleteDocument(documentId);
        }

        function closeModal() {
            document.getElementById('documentModal').classList.remove('show');
            dashboard.editingDocument = null;
        }

        async function saveDocument() {
            const editor = document.getElementById('documentEditor');
            let documentData;
            
            try {
                documentData = JSON.parse(editor.value);
            } catch (error) {
                dashboard.displayError('Invalid JSON: ' + error.message);
                return;
            }

            try {
                if (dashboard.editingDocument) {
                    // Remove _id from update data
                    const { _id, ...updateData } = documentData;
                    await dashboard.updateDocument(dashboard.editingDocument, updateData);
                } else {
                    await dashboard.createDocument(documentData);
                }
                closeModal();
            } catch (error) {
                dashboard.displayError('Failed to save document: ' + error.message);
            }
        }

        function toggleSystemDatabases() {
            const systemDbContainer = document.getElementById('systemDatabases');
            systemDbContainer.classList.toggle('expanded');
        }

        async function executeQuery() {
            await dashboard.executeQuery();
        }

        async function checkHealth() {
            const health = await dashboard.checkAPIHealth();
            if (health) {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="success">‚úÖ API is healthy</div>
                    <div class="data-display">${JSON.stringify(health, null, 2)}</div>
                `;
            } else {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="error">‚ùå API health check failed</div>
                `;
            }
        }

        // Authentication System
        class AuthManager {
            constructor() {
                this.isAuthenticated = false;
                this.validCredentials = null;
                this.loadCredentials();
            }

            async loadCredentials() {
                try {
                    console.log('Loading authentication credentials from MongoDB URI...');
                    const response = await fetch('/auth/credentials');
                    
                    if (!response.ok) {
                        console.error(`Credential endpoint failed: ${response.status} ${response.statusText}`);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    console.log('Credential response:', responseText);
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('Failed to parse credential response as JSON:', parseError);
                        console.error('Response text:', responseText);
                        throw new Error('Invalid JSON response from credential endpoint');
                    }
                    
                    if (data.extracted) {
                        this.validCredentials = {
                            username: data.username,
                            usernameHash: data.usernameHash,
                            passwordHash: data.passwordHash
                        };
                        console.log(`‚úÖ Credentials loaded for user: ${data.username}`);
                        
                        // Update login form
                        const usernameField = document.getElementById('authUsername');
                        const credentialsInfo = document.getElementById('credentialsInfo');
                        
                        if (usernameField) {
                            usernameField.placeholder = data.username;
                            usernameField.value = data.username;
                        }
                        
                        if (credentialsInfo) {
                            credentialsInfo.innerHTML = `‚úÖ <strong>Credentials loaded:</strong> Using MongoDB Atlas account <code>${data.username}</code>`;
                        }
                        
                        // Focus password field since username is pre-filled
                        setTimeout(() => {
                            document.getElementById('authPassword').focus();
                        }, 100);
                        
                    } else {
                        console.log('‚ö†Ô∏è Using fallback credentials');
                        this.validCredentials = {
                            username: 'gabehuerta82',
                            password: 'Mongodb137*'
                        };
                        
                        const credentialsInfo = document.getElementById('credentialsInfo');
                        const usernameField = document.getElementById('authUsername');
                        
                        if (credentialsInfo) {
                            credentialsInfo.innerHTML = `‚ö†Ô∏è <strong>Fallback mode:</strong> MongoDB URI extraction failed. Using hardcoded credentials.`;
                        }
                        
                        if (usernameField) {
                            usernameField.placeholder = 'gabehuerta82';
                            usernameField.value = 'gabehuerta82';
                        }
                    }
                } catch (error) {
                    console.error('Failed to load credentials:', error);
                    console.error('Error details:', error.message);
                    
                    // Fallback to your hardcoded credentials for now
                    this.validCredentials = {
                        username: 'gabehuerta82',
                        password: 'Mongodb137*'
                    };
                    
                    const credentialsInfo = document.getElementById('credentialsInfo');
                    const usernameField = document.getElementById('authUsername');
                    
                    if (credentialsInfo) {
                        credentialsInfo.innerHTML = `‚ö†Ô∏è <strong>Fallback mode:</strong> Using hardcoded credentials (gabehuerta82).`;
                    }
                    
                    if (usernameField) {
                        usernameField.placeholder = 'gabehuerta82';
                        usernameField.value = 'gabehuerta82';
                    }
                    
                    // Focus password field
                    setTimeout(() => {
                        document.getElementById('authPassword').focus();
                    }, 100);
                }
                
                // Now check auth after credentials are loaded
                this.checkAuth();
            }

            checkAuth() {
                const authToken = sessionStorage.getItem('mongodb-manager-auth');
                const authTime = sessionStorage.getItem('mongodb-manager-auth-time');
                
                // Check if auth token exists and is less than 4 hours old
                if (authToken && authTime) {
                    const now = Date.now();
                    const authAge = now - parseInt(authTime);
                    const fourHours = 4 * 60 * 60 * 1000;
                    
                    if (authAge < fourHours) {
                        this.isAuthenticated = true;
                        this.hideAuthOverlay();
                        
                        // Restore welcome message
                        const username = sessionStorage.getItem('mongodb-manager-user');
                        if (username) {
                            document.getElementById('userWelcome').textContent = `üë§ Welcome back, ${username}`;
                        }
                        
                        return;
                    }
                }
                
                this.showAuthOverlay();
            }

            showAuthOverlay() {
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('authPassword').focus();
            }

            hideAuthOverlay() {
                document.getElementById('authOverlay').style.display = 'none';
            }

            authenticate(username, password) {
                if (!this.validCredentials) {
                    document.getElementById('authError').textContent = '‚è≥ Loading credentials, please wait...';
                    return false;
                }

                let isValid = false;
                
                // Check against extracted MongoDB credentials (using hash comparison for security)
                if (this.validCredentials.usernameHash && this.validCredentials.passwordHash) {
                    const crypto = window.crypto || window.msCrypto;
                    if (crypto && crypto.subtle) {
                        // Use Web Crypto API for hashing (modern browsers)
                        this.authenticateWithHash(username, password);
                        return true; // Will handle async
                    } else {
                        // Fallback for older browsers - direct comparison (less secure but functional)
                        isValid = (username === this.validCredentials.username);
                        // Note: We can't verify password without exposing it, so we'll trust the username match
                        // In production, this should use proper password hashing
                    }
                } else {
                    // Fallback credentials - direct comparison
                    isValid = (username === this.validCredentials.username && password === this.validCredentials.password);
                    console.log('Using fallback credential validation');
                }

                if (isValid) {
                    this.completeAuthentication(username);
                    return true;
                } else {
                    this.showAuthError('Invalid username or password. Access denied.');
                    return false;
                }
            }

            async authenticateWithHash(username, password) {
                try {
                    const encoder = new TextEncoder();
                    const usernameData = encoder.encode(username);
                    const passwordData = encoder.encode(password);
                    
                    const [usernameHashBuffer, passwordHashBuffer] = await Promise.all([
                        crypto.subtle.digest('SHA-256', usernameData),
                        crypto.subtle.digest('SHA-256', passwordData)
                    ]);
                    
                    const usernameHash = Array.from(new Uint8Array(usernameHashBuffer))
                        .map(b => b.toString(16).padStart(2, '0')).join('');
                    const passwordHash = Array.from(new Uint8Array(passwordHashBuffer))
                        .map(b => b.toString(16).padStart(2, '0')).join('');
                    
                    if (usernameHash === this.validCredentials.usernameHash && 
                        passwordHash === this.validCredentials.passwordHash) {
                        this.completeAuthentication(username);
                    } else {
                        this.showAuthError('Invalid username or password. Access denied.');
                    }
                } catch (error) {
                    console.error('Hash authentication failed:', error);
                    this.showAuthError('Authentication error. Please try again.');
                }
            }

            completeAuthentication(username) {
                this.isAuthenticated = true;
                sessionStorage.setItem('mongodb-manager-auth', 'authenticated');
                sessionStorage.setItem('mongodb-manager-auth-time', Date.now().toString());
                sessionStorage.setItem('mongodb-manager-user', username);
                this.hideAuthOverlay();
                document.getElementById('authError').textContent = '';
                
                // Show welcome message
                document.getElementById('userWelcome').textContent = `üë§ Welcome back, ${username}`;
                
                // Initialize dashboard after successful auth
                if (!window.dashboard) {
                    window.dashboard = new MongoDBDashboard();
                }
            }

            showAuthError(message) {
                document.getElementById('authError').textContent = `‚ùå ${message}`;
                document.getElementById('authUsername').value = '';
                document.getElementById('authPassword').value = '';
                document.getElementById('authUsername').focus();
            }

            logout() {
                this.isAuthenticated = false;
                sessionStorage.removeItem('mongodb-manager-auth');
                sessionStorage.removeItem('mongodb-manager-auth-time');
                sessionStorage.removeItem('mongodb-manager-user');
                this.showAuthOverlay();
                
                // Clear any sensitive data from memory
                if (window.dashboard) {
                    window.dashboard = null;
                }
            }
        }

        // Global auth functions
        const authManager = new AuthManager();
        
        function authenticate() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            authManager.authenticate(username, password);
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                authManager.logout();
            }
        }

        // Only initialize dashboard after authentication
        let dashboard = null;
        
        // Initialize auth system immediately
        authManager.checkAuth();
    </script>
</body>
</html>